// Prisma schema — versión corregida y extendida
// Compatible con seed.js y módulo Auth

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- Enums ---------------------------------------------------

enum TransactionType {
  debit
  credit
}

enum BudgetPeriod {
  monthly
  weekly
  yearly
}

enum AlertType {
  budget_over
  anomaly
  recurring_due
}

enum AccountType {
  CUENTA_CORRIENTE
  CUENTA_VISTA
  CUENTA_AHORRO
  TARJETA_CREDITO
}

enum Currency {
  CLP
  USD
  EUR
}

// --- Modelos -------------------------------------------------

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique @db.VarChar(160)
  passwordHash String
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  rut          String?  @db.VarChar(16)
  phone        String?  @db.VarChar(24)

  accounts   Account[]
  budgets    Budget[]
  alerts     Alert[]
  categories Category[]
}

model Account {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bank          String
  accountType   AccountType
  accountNumber String
  holderName    String
  rutTitular    String      @db.VarChar(16)

  alias       String?
  active      Boolean @default(true)
  provider    String?
  providerRef String?

  currency     Currency @default(CLP)
  balanceCents Int      @default(0)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  transactions Transaction[]

  @@unique([userId, bank, accountType, accountNumber])
  @@index([userId])
}

model Category {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String     @db.VarChar(80)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  color    String?

  txs     Transaction[]
  budgets Budget[]

  @@unique([userId, name])
  @@index([userId])
  @@index([parentId])
}

model Transaction {
  id         String    @id @default(uuid())
  accountId  String
  account    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])

  bookedAt          DateTime        @db.Timestamptz(6)
  postedAt          DateTime?       @db.Timestamptz(6)
  valueCents        Int
  type              TransactionType
  merchant          String?         @db.VarChar(120)
  description       String?         @db.VarChar(240)
  anomalyScore      Float?
  isRecurring       Boolean         @default(false)
  balanceAfterCents Int?
  externalId        String?

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  alerts    Alert[]

  @@unique([accountId, externalId])
  @@index([accountId, bookedAt(sort: Desc)])
  @@index([categoryId])
}

model Budget {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  categoryId  String
  category    Category     @relation(fields: [categoryId], references: [id])
  amountCents Int
  period      BudgetPeriod @default(monthly)
  startMonth  DateTime     @db.Timestamptz(6)

  @@unique([userId, categoryId, period])
}

model Alert {
  id            String       @id @default(uuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactionId String?
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  type          AlertType
  payload       Json
  createdAt     DateTime     @default(now()) @db.Timestamptz(6)
  readAt        DateTime?

  @@index([userId, createdAt])
}
